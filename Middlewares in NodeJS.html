<div class="note-header">Middlewares in NodeJS</div><div class="step-header">Step: 1 What is middleware?</div><div class="description">Middleware functions are functions that have access to the request object (req), the response object (res), and the next function in the applicationâ€™s request-response cycle. The next function is a function in the Express router which, when invoked, executes the middleware succeeding the current middleware.</div><div class="step-header">Step: 2 Below is the example of simple logger middleware</div><div class="description"><div style="color: rgb(212, 212, 212); background-color: rgb(30, 30, 30); font-family: &quot;Droid Sans Mono&quot;, &quot;monospace&quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;"><div><span style="color: #569cd6;">const</span> <span style="color: #dcdcaa;">express</span> = <span style="color: #dcdcaa;">require</span>(<span style="color: #ce9178;">"express"</span>);</div><div><span style="color: #569cd6;">const</span> <span style="color: #4fc1ff;">app</span> = <span style="color: #dcdcaa;">express</span>();</div><div><span style="color: #569cd6;">const</span> <span style="color: #4fc1ff;">PORT</span> = <span style="color: #b5cea8;">8700</span>;</div><div style="color: rgb(212, 212, 212); background-color: rgb(30, 30, 30); font-family: &quot;Droid Sans Mono&quot;, &quot;monospace&quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;"><br></div><br><div><span style="color: #6a9955;">//adding middleware at the global level</span></div><div><span style="color: #4fc1ff;">app</span>.<span style="color: #dcdcaa;">use</span>(<span style="color: #dcdcaa;">Logger</span>);</div><div style="color: rgb(212, 212, 212); background-color: rgb(30, 30, 30); font-family: &quot;Droid Sans Mono&quot;, &quot;monospace&quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;"><br></div><br><div><span style="color: #6a9955;">// Root API</span></div><div><span style="color: #4fc1ff;">app</span>.<span style="color: #dcdcaa;">get</span>(<span style="color: #ce9178;">"/"</span>, (<span style="color: #9cdcfe;">req</span>, <span style="color: #9cdcfe;">res</span>) <span style="color: #569cd6;">=&gt;</span> {</div><div>  <span style="color: #9cdcfe;">console</span>.<span style="color: #dcdcaa;">log</span>(<span style="color: #ce9178;">"This is a root API"</span>);</div><div>  <span style="color: #9cdcfe;">res</span>.<span style="color: #dcdcaa;">send</span>(<span style="color: #ce9178;">"Hi, I am a Express server"</span>);</div><div>});</div><div style="color: rgb(212, 212, 212); background-color: rgb(30, 30, 30); font-family: &quot;Droid Sans Mono&quot;, &quot;monospace&quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;"><br></div><br><div><span style="color: #6a9955;">// Logger middleware</span></div><div><span style="color: #569cd6;">function</span> <span style="color: #dcdcaa;">Logger</span>(<span style="color: #9cdcfe;">req</span>, <span style="color: #9cdcfe;">resp</span>, <span style="color: #9cdcfe;">next</span>) {</div><div>  <span style="color: #9cdcfe;">console</span>.<span style="color: #dcdcaa;">log</span>(<span style="color: #ce9178;">"I am a logger middleware"</span>);</div><div>  <span style="color: #6a9955;">//  by calling next(), we are sending the control</span></div><div>  <span style="color: #6a9955;">//  to the succeding(or next) middleware, in our case "/" handler.</span></div><div>  <span style="color: #dcdcaa;">next</span>();</div><div>}</div><div><br></div><br><div><span style="color: #6a9955;">// Listen</span></div><div><span style="color: #4fc1ff;">app</span>.<span style="color: #dcdcaa;">listen</span>(<span style="color: #4fc1ff;">PORT</span>, () <span style="color: #569cd6;">=&gt;</span></div><div>  <span style="color: #9cdcfe;">console</span>.<span style="color: #dcdcaa;">log</span>(<span style="color: #ce9178;">`Server is running on http://localhost:</span><span style="color: #569cd6;">${</span><span style="color: #4fc1ff;">PORT</span><span style="color: #569cd6;">}</span><span style="color: #ce9178;">`</span>)</div><div>);</div><div style="color: rgb(212, 212, 212); background-color: rgb(30, 30, 30); font-family: &quot;Droid Sans Mono&quot;, &quot;monospace&quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;"><br></div><br><div><span style="color: #6a9955;">// ===========================Output=========================</span></div><div><span style="color: #6a9955;">// Server is running on http://localhost:8700</span></div><div><span style="color: #6a9955;">// I am a logger middleware</span></div><div><span style="color: #6a9955;">// This is a root API</span></div><br></div></div><div class="step-header">Step: 3 Middleware can be added at the global level(at the very entry point of the routes, as shown in the above step), or to a specific route, or can be called after the route handler.</div><div class="description">Adding middleware to a specific route.<div><br></div><div><br><div><br></div><div><div style="color: rgb(212, 212, 212); background-color: rgb(30, 30, 30); font-family: &quot;Droid Sans Mono&quot;, &quot;monospace&quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;"><div><span style="color: #569cd6;">const</span> <span style="color: #dcdcaa;">express</span> = <span style="color: #dcdcaa;">require</span>(<span style="color: #ce9178;">"express"</span>);</div><div><span style="color: #569cd6;">const</span> <span style="color: #4fc1ff;">app</span> = <span style="color: #dcdcaa;">express</span>();</div><div><span style="color: #569cd6;">const</span> <span style="color: #4fc1ff;">PORT</span> = <span style="color: #b5cea8;">8700</span>;</div><br><div><span style="color: #6a9955;">// Below, we are passing Logger as a second param to the Root API/handler,</span></div><div><span style="color: #6a9955;">// instead of adding it as a global ie, app.use(middlewarename).</span></div><div><span style="color: #6a9955;">// So Logger middleware will be applicable only to this route, and </span></div><div><span style="color: #6a9955;">// once after the </span><span style="color: rgb(106, 153, 85);">Logger middleware job gets completed, control will be</span></div><div><span style="color: rgb(106, 153, 85);">// passed on to </span><span style="color: rgb(106, 153, 85);">the "/" handler.</span></div><div><span style="color: #4fc1ff;">app</span>.<span style="color: #dcdcaa;">get</span>(<span style="color: #ce9178;">"/"</span>, <span style="color: #dcdcaa;">Logger</span>, (<span style="color: #9cdcfe;">req</span>, <span style="color: #9cdcfe;">res</span>) <span style="color: #569cd6;">=&gt;</span> {</div><div>  <span style="color: #9cdcfe;">console</span>.<span style="color: #dcdcaa;">log</span>(<span style="color: #ce9178;">"This is a root API"</span>);</div><div>  <span style="color: #9cdcfe;">res</span>.<span style="color: #dcdcaa;">send</span>(<span style="color: #ce9178;">"Hi, I am a Express server"</span>);</div><div>});</div><br><div><span style="color: #6a9955;">// Logger middleware</span></div><div><span style="color: #569cd6;">function</span> <span style="color: #dcdcaa;">Logger</span>(<span style="color: #9cdcfe;">req</span>, <span style="color: #9cdcfe;">resp</span>, <span style="color: #9cdcfe;">next</span>) {</div><div>  <span style="color: #9cdcfe;">console</span>.<span style="color: #dcdcaa;">log</span>(<span style="color: #ce9178;">"I am a logger middleware"</span>);</div><div>  <span style="color: #6a9955;">//  by calling next(), we are sending the control</span></div><div>  <span style="color: #6a9955;">//  to the succeding(or next) middleware, in our case "/" handler.</span></div><div>  <span style="color: #dcdcaa;">next</span>();</div><div>}</div><br><div><span style="color: #6a9955;">// Listen</span></div><div><span style="color: #4fc1ff;">app</span>.<span style="color: #dcdcaa;">listen</span>(<span style="color: #4fc1ff;">PORT</span>, () <span style="color: #569cd6;">=&gt;</span></div><div>  <span style="color: #9cdcfe;">console</span>.<span style="color: #dcdcaa;">log</span>(<span style="color: #ce9178;">`Server is running on http://localhost:</span><span style="color: #569cd6;">${</span><span style="color: #4fc1ff;">PORT</span><span style="color: #569cd6;">}</span><span style="color: #ce9178;">`</span>)</div><div>);</div><br><div><span style="color: #6a9955;">// ===========================Output=========================</span></div><div><span style="color: #6a9955;">// Server is running on http://localhost:8700</span></div><div><span style="color: #6a9955;">// I am a logger middleware</span></div><div><span style="color: #6a9955;">// This is a root API</span></div><br></div></div></div></div><div class="step-header">Step: 4 Calling middleware after the handler.(within the API handler)</div><div class="description">This means, that if we want to call a middleware once our API handler logic gets executed, we can call next() within the API handler as shown below.<br><br>Note: In the below example app.use() is present after the API handler, if we add it before the API handler, the middleware will be applied globally and the sequence of execution changes(meaning that, the middleware will be executed first and then the API handler).<div><br></div><div><br></div><div><br></div><div><div style="color: rgb(212, 212, 212); background-color: rgb(30, 30, 30); font-family: &quot;Droid Sans Mono&quot;, &quot;monospace&quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;"><div><span style="color: #569cd6;">const</span> <span style="color: #dcdcaa;">express</span> = <span style="color: #dcdcaa;">require</span>(<span style="color: #ce9178;">"express"</span>);</div><div><span style="color: #569cd6;">const</span> <span style="color: #4fc1ff;">app</span> = <span style="color: #dcdcaa;">express</span>();</div><div><span style="color: #569cd6;">const</span> <span style="color: #4fc1ff;">PORT</span> = <span style="color: #b5cea8;">8700</span>;</div><br><br><div><span style="color: #6a9955;">// Below, we are calling the next(), once after sending the response.</span></div><div><span style="color: #6a9955;">// so after sending the response control will go to the Logger middleware</span></div><div><span style="color: #4fc1ff;">app</span>.<span style="color: #dcdcaa;">get</span>(<span style="color: #ce9178;">"/"</span>, (<span style="color: #9cdcfe;">req</span>, <span style="color: #9cdcfe;">res</span>, <span style="color: #dcdcaa;">next</span>) <span style="color: #569cd6;">=&gt;</span> {</div><div>  <span style="color: #9cdcfe;">console</span>.<span style="color: #dcdcaa;">log</span>(<span style="color: #ce9178;">"This is a root API"</span>);</div><div>  <span style="color: #9cdcfe;">res</span>.<span style="color: #dcdcaa;">send</span>(<span style="color: #ce9178;">"Hi, I am a Express server"</span>);</div><div>  <span style="color: #dcdcaa;">next</span>(); <span style="color: #6a9955;">// passing the controll to the next middleware(in our case</span></div><div><span style="color: #6a9955;">          // Logger)</span></div><div>});</div><br><br><div><span style="color: #6a9955;">// adding middleware after the route handler</span></div><div><span style="color: #4fc1ff;">app</span>.<span style="color: #dcdcaa;">use</span>(<span style="color: #dcdcaa;">Logger</span>);</div><br><br><div><span style="color: #6a9955;">// Logger middleware</span></div><div><span style="color: #569cd6;">function</span> <span style="color: #dcdcaa;">Logger</span>(<span style="color: #9cdcfe;">req</span>, <span style="color: #9cdcfe;">resp</span>, <span style="color: #9cdcfe;">next</span>) {</div><div>  <span style="color: #9cdcfe;">console</span>.<span style="color: #dcdcaa;">log</span>(<span style="color: #ce9178;">"I am a logger middleware"</span>);</div><div>  <span style="color: #6a9955;">//  by calling next(), we are sending the control</span></div><div>  <span style="color: #6a9955;">//  to the succeding(or next) middleware, in our case "/" handler.</span></div><div>  <span style="color: #c586c0;">return</span>;</div><div>}</div><br><br><div><span style="color: #6a9955;">// Listen</span></div><div><span style="color: #4fc1ff;">app</span>.<span style="color: #dcdcaa;">listen</span>(<span style="color: #4fc1ff;">PORT</span>, () <span style="color: #569cd6;">=&gt;</span></div><div>  <span style="color: #9cdcfe;">console</span>.<span style="color: #dcdcaa;">log</span>(<span style="color: #ce9178;">`Server is running on http://localhost:</span><span style="color: #569cd6;">${</span><span style="color: #4fc1ff;">PORT</span><span style="color: #569cd6;">}</span><span style="color: #ce9178;">`</span>)</div><div>);</div><br><br><div><span style="color: #6a9955;">// ===========================Output=========================</span></div><div><span style="color: #6a9955;">// Server is running on http://localhost:8700</span></div><div><span style="color: #6a9955;">// This is a root API</span></div><div><span style="color: #6a9955;">// I am a logger middleware</span></div><br></div></div><div><br></div><div><br></div></div><div class="step-header">Step: 5 Most common mistakes</div><div class="description">Note: Next() is not like a return, statements after next() also get executed once the control comes back.<div><br><div><div>The below example explains how it works.</div></div></div><div><br></div><div><br></div><div><div style="color: rgb(212, 212, 212); background-color: rgb(30, 30, 30); font-family: &quot;Droid Sans Mono&quot;, &quot;monospace&quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;"><div><span style="color: #569cd6;">const</span> <span style="color: #dcdcaa;">express</span> = <span style="color: #dcdcaa;">require</span>(<span style="color: #ce9178;">"express"</span>);</div><div><span style="color: #569cd6;">const</span> <span style="color: #4fc1ff;">app</span> = <span style="color: #dcdcaa;">express</span>();</div><div><span style="color: #569cd6;">const</span> <span style="color: #4fc1ff;">PORT</span> = <span style="color: #b5cea8;">8700</span>;</div><br><br><div><span style="color: #6a9955;">// Below, we are calling the next(), once after sending the response.</span></div><div><span style="color: #6a9955;">// so after sending the response control will go to the Logger </span></div><div><span style="color: #6a9955;">//middleware</span></div><div><span style="color: #4fc1ff;">app</span>.<span style="color: #dcdcaa;">get</span>(<span style="color: #ce9178;">"/"</span>, (<span style="color: #9cdcfe;">req</span>, <span style="color: #9cdcfe;">res</span>, <span style="color: #dcdcaa;">next</span>) <span style="color: #569cd6;">=&gt;</span> {</div><div>  <span style="color: #9cdcfe;">console</span>.<span style="color: #dcdcaa;">log</span>(<span style="color: #ce9178;">"This is a root API"</span>);</div><div>  <span style="color: #9cdcfe;">res</span>.<span style="color: #dcdcaa;">send</span>(<span style="color: #ce9178;">"Hi, I am a Express server"</span>);</div><div>  <span style="color: #dcdcaa;">next</span>(); <span style="color: #6a9955;">// passing the controll to the next middleware(in our case</span></div><div><span style="color: #6a9955;">          // Logger)</span></div><div><span style="color: #6a9955;">  // if we add retun here, the statement will not be executed.</span></div><div>  <span style="color: #9cdcfe;">console</span>.<span style="color: #dcdcaa;">log</span>(</div><div>    <span style="color: #ce9178;">"This statement will be excuted after contorl \</span></div><div><span style="color: #ce9178;">     comes back from the Logger middleware"</span></div><div>  );</div><div>});</div><br><br><div><span style="color: #6a9955;">// adding middleware after the route handler</span></div><div><span style="color: #4fc1ff;">app</span>.<span style="color: #dcdcaa;">use</span>(<span style="color: #dcdcaa;">Logger</span>);</div><br><br><div><span style="color: #6a9955;">// Logger middleware</span></div><div><span style="color: #569cd6;">function</span> <span style="color: #dcdcaa;">Logger</span>(<span style="color: #9cdcfe;">req</span>, <span style="color: #9cdcfe;">resp</span>, <span style="color: #9cdcfe;">next</span>) {</div><div>  <span style="color: #9cdcfe;">console</span>.<span style="color: #dcdcaa;">log</span>(<span style="color: #ce9178;">"I am a logger middleware"</span>);</div><div>  <span style="color: #6a9955;">//  by calling next(), we are sending the control</span></div><div>  <span style="color: #6a9955;">//  to the succeding(or next) middleware, in our case "/" handler.</span></div><div>  <span style="color: #c586c0;">return</span>;</div><div>}</div><br><br><div><span style="color: #6a9955;">// Listen</span></div><div><span style="color: #4fc1ff;">app</span>.<span style="color: #dcdcaa;">listen</span>(<span style="color: #4fc1ff;">PORT</span>, () <span style="color: #569cd6;">=&gt;</span></div><div>  <span style="color: #9cdcfe;">console</span>.<span style="color: #dcdcaa;">log</span>(<span style="color: #ce9178;">`Server is running on http://localhost:</span><span style="color: #569cd6;">${</span><span style="color: #4fc1ff;">PORT</span><span style="color: #569cd6;">}</span><span style="color: #ce9178;">`</span>)</div><div>);</div><br><br><div><span style="color: #6a9955;">// ===========================Output=========================</span></div><div><span style="color: #6a9955;">// Server is running on http://localhost:8700</span></div><div><span style="color: #6a9955;">// This is a root API</span></div><div><span style="color: #6a9955;">// I am a logger middleware</span></div><div><span style="color: #6a9955;">// This statement will be excuted after contorl comes back from the </span></div><div><span style="color: #6a9955;">Logger middleware</span></div><br></div></div></div>